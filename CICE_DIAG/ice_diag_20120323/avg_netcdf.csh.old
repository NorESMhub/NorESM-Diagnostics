#!/bin/csh -f

# This file creates a list of netCDF files and averages these to get
# seasonal and annual means.  Input data is:
#
# $DATE_FORMAT  form of date in history file name (eg. yyyy-mm), input
# $PATHDAT  directory on dataproc where data is 
# $PATHJLS  directory on dataproc where data will be written
# $FILE_HEADER  beginning of filename
# $first_year first year to be averaged
# $last_year last year to be averaged
# $SEAS_MEAN seasonal mean

if ($#argv != 3) then
  echo "usage: avg_netcdf.csh $DATE_FORMAT $FIRST_YEAR $LAST_YEAR "
  exit
endif

set echo on

set DATE_FORMAT = $1
@ first_yr = $2
@ last_yr = $3

@ YR = $first_yr
# Delete existing djf file, or it gets bigger and bigger
if (-e $SEAS_MEAN.asc) 'rm' -f $SEAS_MEAN.asc

while ($YR <= $last_yr) 

  set filenames = ()
  set four_digit_year = `printf "%04d" {$YR}`
  set date_string = `echo $DATE_FORMAT | sed s/yyyy/$four_digit_year/`
  set date_no_mnth = `echo $date_string | sed s/dd/01/`

  if ($SEAS_MEAN == jfm) then
    foreach month (01 02 03)
      set date = `echo $date_no_mnth | sed s/mm/$month/`
      set filenames = ($filenames ${PATHDAT}/${FILE_HEADER}${date}.nc)
    end
  endif

  if ($SEAS_MEAN == fm) then
    foreach month (02 03)
      set date = `echo $date_no_mnth | sed s/mm/$month/`
      set filenames = ($filenames ${PATHDAT}/${FILE_HEADER}${date}.nc)
    end
  endif

  if ($SEAS_MEAN == amj) then
    foreach month (04 05 06)
      set date = `echo $date_no_mnth | sed s/mm/$month/`
      set filenames = ($filenames ${PATHDAT}/${FILE_HEADER}${date}.nc)
    end
  endif

  if ($SEAS_MEAN == jas) then
    foreach month (07 08 09)
      set date = `echo $date_no_mnth | sed s/mm/$month/`
      set filenames = ($filenames ${PATHDAT}/${FILE_HEADER}${date}.nc)
    end
  endif

  if ($SEAS_MEAN == ond) then
    foreach month (10 11 12)
      set date = `echo $date_no_mnth | sed s/mm/$month/`
      set filenames = ($filenames ${PATHDAT}/${FILE_HEADER}${date}.nc)
    end
  endif

  if ($SEAS_MEAN == on) then
    foreach month (10 11)
      set date = `echo $date_no_mnth | sed s/mm/$month/`
      set filenames = ($filenames ${PATHDAT}/${FILE_HEADER}${date}.nc)
    end
  endif

  if ($SEAS_MEAN == ann) then
    set filenames = (${filenames} ${PATHDAT}/${FILE_HEADER}${four_digit_year}*.nc)
  endif

  ls ${filenames} >> $SEAS_MEAN.asc

  @ YR++

end

set files = `cat {$SEAS_MEAN}.asc`

# Average files in $SEAS_MEAN.asc , overwriting existing output file

ncra -O $files $AVG_FILE

if (-e $SEAS_MEAN.asc) 'rm' -f $SEAS_MEAN.asc  # Remove .asc files after computing avg
  
